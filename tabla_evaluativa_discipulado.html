<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Evaluación Discipulado – Alabanza y Adoración</title>
  <!--
    Esta página HTML implementa un sistema integral de seguimiento y evaluación
    para un discipulado de alabanza y adoración. Cada clase se valora sobre
    20 puntos distribuidos en cinco indicadores: Asistencia, Puntualidad,
    Participación, Compromiso y Tarea/Responsabilidad. Las opciones de
    evaluación reflejan las escalas especificadas (4, 3, 2, 1, 0), y se
    almacenan en localStorage para persistencia del lado del cliente.

    Además de la matriz de evaluación por sesión y alumno, la página cuenta
    con un panel de estadísticas que permite seleccionar a un alumno y
    visualizar un resumen de su desempeño promedio por indicador, junto con
    métricas clave (faltas y llegadas tarde). Para la visualización se
    incorpora Chart.js desde CDN.
  -->
  <style>
    /* Tipografía y esquema de color personalizado */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

    :root {
      /* Paleta inspirada en la imagen "ocean" para acentos */
      --bondi-blue: #0799b6;
      --san-marino: #4a6eb0;
      --eden: #114c5f;
      --sinbad: #9cd2d3;
      --janna: #f2e0cf;
      /* Neutros para fondos y bordes
         Elegimos tonos muy claros para que los acentos destaquen sin saturar.
         Estos colores se inspiran en interfaces limpias y modernas (grises, cremas y blancos). */
      --gray-light: #f5f6fa; /* fondo principal */
      --gray: #e0e3e8;       /* bordes y divisores */
      --cream: #fafafa;      /* tarjetas y áreas internas */
      --text-primary: #2c3e50;
      --text-secondary: #6b7280;
    }

    /* Reset básico */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: var(--gray-light);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 0.5rem;
      color: var(--eden);
      font-weight: 600;
    }
    h2 {
      margin-top: 2rem;
      margin-bottom: 1rem;
      color: var(--eden);
      font-weight: 500;
      text-align: center;
    }
    p.instructions {
      text-align: center;
      max-width: 900px;
      margin: 0 auto 1.75rem auto;
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    /* Barra de botones */
    .button-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .button-bar button,
    .button-bar label span {
      background-color: var(--bondi-blue);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.55rem 1.2rem;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: background-color 0.2s ease-in-out;
    }
    .button-bar button:hover,
    .button-bar label span:hover {
      background-color: var(--eden);
    }

    /* Contenedor de sesiones en formato tarjetas */
    #sessions-container {
      /* Apilar las sesiones de forma vertical para dar mayor amplitud al contenido. */
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .session-card {
      background: var(--cream);
      border: 1px solid var(--gray);
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: box-shadow 0.2s ease;
    }
    .session-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    .session-header {
      background-color: var(--gray-light);
      color: var(--text-primary);
      padding: 0.8rem 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      /* Borde izquierdo como acento sutil */
      border-left: 4px solid var(--bondi-blue);
    }
    .session-body {
      padding: 0.8rem 1rem 1rem 1rem;
      /* Oculta por defecto; se mostrará al expandir la tarjeta */
      display: none;
      flex-direction: column;
      font-size: 0.9rem;
      line-height: 1.5;
      /* Permite que el contenido se desborde horizontalmente, evitando que los select se recorten. */
      overflow-x: auto;
    }
    .session-body p {
      margin: 0.25rem 0;
    }
    .session-body strong {
      color: var(--eden);
      font-weight: 500;
    }
    .toggle-icon {
      margin-left: 0.5rem;
      font-size: 1rem;
      color: var(--bondi-blue);
      transform: rotate(0deg);
      transition: transform 0.2s;
    }
    .session-card.open .toggle-icon {
      transform: rotate(90deg);
    }
    .session-card.open .session-body {
      display: flex;
    }

    /* Tabla de evaluación */
    table.evaluation-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.6rem;
      /* Evita que la tabla rompa el layout; se adapta a su contenedor */
      min-width: 700px;
    }
    table.evaluation-table th,
    table.evaluation-table td {
      border: 1px solid var(--gray);
      padding: 0.5rem 0.4rem;
      text-align: left;
      font-size: 0.8rem;
      white-space: nowrap;
      min-width: 110px;
    }
    table.evaluation-table th {
      background-color: var(--gray-light);
      color: var(--text-primary);
      font-weight: 500;
    }
    table.evaluation-table select,
    table.evaluation-table input[type="text"] {
      width: 100%;
      padding: 0.3rem;
      font-size: 0.8rem;
      border: 1px solid var(--gray);
      border-radius: 4px;
      background-color: #fff;
      color: var(--text-primary);
    }
    table.evaluation-table input[type="text"] {
      font-style: italic;
    }

    /* Sección de estadísticas */
    #stats-section {
      margin-top: 2rem;
      background: var(--cream);
      border: 1px solid var(--gray);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    #stats-section label {
      margin-right: 0.5rem;
      font-weight: 600;
      color: var(--eden);
    }
    #stats-summary {
      margin-top: 1rem;
      font-size: 0.85rem;
      line-height: 1.4;
      color: var(--text-secondary);
    }

    /* Adaptación responsive */
    @media (max-width: 600px) {
      table.evaluation-table th,
      table.evaluation-table td {
        font-size: 0.7rem;
        padding: 0.3rem;
      }
      .button-bar button,
      .button-bar label span {
        font-size: 0.75rem;
        padding: 0.45rem 1rem;
      }
      .session-header {
        padding: 0.7rem 0.8rem;
      }
      .session-body {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <h1>Sistema de Evaluación – Discipulado de Alabanza</h1>
  <p class="instructions">
    Cada clase se evalúa sobre 20&nbsp;puntos distribuidos en cinco indicadores: Asistencia, Puntualidad,
    Participación, Compromiso y Tarea/Responsabilidad. Selecciona la puntuación correspondiente
    para cada alumno en cada clase. Los datos se guardan automáticamente en tu navegador.
    Puedes exportar un respaldo en formato JSON o importar datos previamente guardados.
  </p>
  <div class="button-bar">
    <button id="exportBtn">Exportar datos</button>
    <label for="importFile" style="position: relative; overflow: hidden;">
      <input type="file" id="importFile" accept="application/json" style="position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer;"/>
      <span>Importar datos</span>
    </label>
  </div>
  <div id="sessions-container"></div>

  <h2>Estadísticas por alumno</h2>
  <div id="stats-section">
    <div>
      <label for="studentSelect">Selecciona alumno:</label>
      <select id="studentSelect"></select>
    </div>
    <canvas id="studentChart" style="max-width:100%;max-height:350px;"></canvas>
    <div id="stats-summary"></div>

    <!-- Gráfico de desempeño global -->
    <h3 id="global-chart-title" style="margin-top:2rem;color: var(--eden); font-weight:600; text-align:center;">Desempeño global de alumnos</h3>
    <canvas id="globalChart" style="max-width:100%;max-height:350px;"></canvas>
  </div>

  <!-- Dependencia para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Sesiones con información detallada. Tomadas del documento de discipulado.
    const sessions = [
      {
        id: 1,
        title: "¿Qué es la adoración verdadera?",
        premise: "La adoración no es solo un acto musical, sino una vida entregada a Dios en espíritu y verdad.",
        objective: "Entender que la adoración verdadera es un estilo de vida y no un momento aislado.",
        reflection: "Comprometerse a vivir una vida de adoración más allá de la plataforma, cultivando la relación con Dios en lo secreto.",
        focus: "Más allá de la música: intimidad, obediencia y entrega en todas las áreas de la vida.",
        scripture: "Juan 4:23–24; Génesis 22:5",
        tasks: "Memorizar Juan&nbsp;4:23–24 y Génesis&nbsp;22:5; reflexionar acerca de cómo tu vida cotidiana expresa adoración."
      },
      {
        id: 2,
        title: "Identidad del adorador",
        premise: "Un ministerio de alabanza genuino depende de la vida personal con Dios.",
        objective: "Fomentar la importancia de un altar personal y una vida devocional consistente.",
        reflection: "Estar comprometidos a orar y leer la Biblia regularmente, buscando una conexión profunda con Dios.",
        focus: "Conocer la identidad como hijo de Dios antes de servir para evitar buscar aprobación a través del ministerio.",
        scripture: "Salmo 139; Efesios 1:4–5",
        tasks: "Establecer un altar personal de oración y lectura bíblica; memorizar Salmo&nbsp;139 y Efesios&nbsp;1:4–5."
      },
      {
        id: 3,
        title: "El carácter del ministro",
        premise: "El ministerio debe fluir desde una identidad firmemente establecida en Cristo.",
        objective: "Comprender que el valor no depende del servicio ministerial, sino de la relación con Dios.",
        reflection: "Ministrar desde seguridad en la identidad como hijos de Dios, evitando la comparación y el orgullo.",
        focus: "Puntualidad, humildad, respeto, integridad y sujeción: el carácter sostiene lo que el talento no puede.",
        scripture: "1 Timoteo 4:12",
        tasks: "Trabajar en el carácter: ser puntual, humilde, respetuoso e íntegro; memorizar 1&nbsp;Timoteo&nbsp;4:12."
      },
      {
        id: 4,
        title: "El altar personal",
        premise: "La técnica es importante, pero el carácter es aún más esencial para un ministerio genuino.",
        objective: "Desarrollar un carácter que refleje el corazón de Cristo, además de habilidades musicales.",
        reflection: "Priorizar el carácter: buscar la humildad, la integridad y servir con un corazón puro.",
        focus: "El adorador no puede dar lo que no tiene: cultivar una vida secreta de oración, adoración y Palabra.",
        scripture: "Mateo 6:6",
        tasks: "Desarrollar una vida secreta de oración y adoración; memorizar Mateo&nbsp;6:6."
      },
      {
        id: 5,
        title: "La unción en la adoración",
        premise: "La unidad en el equipo de alabanza es fundamental para que el Espíritu se mueva libremente.",
        objective: "Promover compañerismo, apoyo mutuo y unidad entre los miembros del equipo.",
        reflection: "Trabajar en armonía, resolver conflictos de manera bíblica y apoyarse mutuamente en oración y servicio.",
        focus: "Diferenciar entre cantar bien y ministrar bajo la unción; cultivar sensibilidad al Espíritu Santo.",
        scripture: "1 Samuel 16:23",
        tasks: "Promover la unidad resolviendo conflictos con amor; practicar la sensibilidad al Espíritu; memorizar 1&nbsp;Samuel&nbsp;16:23."
      },
      {
        id: 6,
        title: "La ética del ministro de alabanza",
        premise: "La puntualidad y el compromiso son indicadores del nivel de honor y respeto por el ministerio.",
        objective: "Enseñar la importancia de ser responsables y puntuales en todos los aspectos del ministerio.",
        reflection: "Asumir una actitud profesional y comprometida, cumpliendo las responsabilidades con excelencia.",
        focus: "Cuidar las relaciones dentro y fuera del equipo; actuar con honra ante desacuerdos; respetar líderes y hermanos.",
        scripture: "Romanos 12:10; Hebreos 13:17",
        tasks: "Ser puntual y responsable en ensayos y servicios; honrar y obedecer a los líderes; memorizar Romanos&nbsp;12:10 y Hebreos&nbsp;13:17."
      },
      {
        id: 7,
        title: "El poder espiritual de la alabanza",
        premise: "La excelencia en la música honra a Dios y prepara el ambiente para Su presencia.",
        objective: "Desarrollar habilidades técnicas en la música para servir con excelencia y dedicación.",
        reflection: "Practicar regularmente y esforzarse por mejorar para ofrecer lo mejor a Dios.",
        focus: "La adoración como arma espiritual en batalla; estudiar casos bíblicos donde Dios operó a través de cantores.",
        scripture: "2 Crónicas 20:21–22; Hechos 16:25–26",
        tasks: "Practicar habilidades musicales; estudiar las historias de 2&nbsp;Crónicas&nbsp;20:21–22 y Hechos&nbsp;16:25–26; reflexionar sobre la adoración como arma espiritual."
      },
      {
        id: 8,
        title: "El fluir profético en la adoración",
        premise: "Conocer las estructuras musicales y el repertorio es esencial para ministrar de manera fluida y efectiva.",
        objective: "Equipar a los adoradores con los conocimientos musicales básicos para desempeñarse adecuadamente.",
        reflection: "Estar familiarizados con el repertorio y la estructura musical de cada canción para un servicio fluido y ordenado.",
        focus: "Dejar espacio para que Dios hable; identificar el fluir del Espíritu sin caer en desorden.",
        scripture: "Romanos 8:14; 1 Corintios 14:26–33",
        tasks: "Estudiar las estructuras y repertorio; permitir espacios de adoración espontánea; memorizar Romanos&nbsp;8:14 y 1&nbsp;Corintios&nbsp;14:26–33."
      },
      {
        id: 9,
        title: "Excelencia musical y espiritual",
        premise: "El buen uso de los equipos técnicos mejora la calidad del servicio y evita distracciones.",
        objective: "Capacitar en el manejo adecuado de los equipos técnicos durante el servicio.",
        reflection: "Ser responsables del manejo de los equipos, asegurándose de que todo funcione correctamente antes y durante el servicio.",
        focus: "Ensayar con propósito, preparar técnica y espiritualmente: la excelencia honra a Dios.",
        scripture: "1 Crónicas 25:7; 2 Timoteo 2:15",
        tasks: "Aprender el manejo de equipos técnicos; practicar con propósito; memorizar 1&nbsp;Crónicas&nbsp;25:7 y 2&nbsp;Timoteo&nbsp;2:15."
      },
      {
        id: 10,
        title: "Fluir con el Espíritu: sensibilidad y discernimiento",
        premise: "La verdadera adoración fluye desde la sensibilidad y el discernimiento del Espíritu Santo.",
        objective: "Fomentar la capacidad de los adoradores para discernir el movimiento del Espíritu y ajustarse a Él.",
        reflection: "Estar atentos a la dirección del Espíritu Santo, permitiendo que Él guíe la adoración sin depender de guiones.",
        focus: "Construir relaciones sanas, evitar competencia, fomentar compañerismo y colaboración.",
        scripture: "Salmo 133:1",
        tasks: "Practicar la sensibilidad espiritual en los servicios; cultivar relaciones sanas dentro del equipo; memorizar Salmo&nbsp;133:1."
      },
      {
        id: 11,
        title: "Sensibilidad al ambiente espiritual",
        premise: "La adoración profética permite que la voz de Dios se exprese a través de Su pueblo.",
        objective: "Introducir a los adoradores en el fluir profético, enseñándoles a cantar lo que el Espíritu está diciendo.",
        reflection: "Estar abiertos a cantar espontáneamente y ser sensibles a lo que el Espíritu está revelando en el momento.",
        focus: "Discernir qué está haciendo el Espíritu Santo en un servicio y cómo acompañar desde la adoración.",
        scripture: "Juan 5:19",
        tasks: "Ejercitar la adoración profética; cantar espontáneamente al Espíritu; memorizar Juan&nbsp;5:19."
      },
      {
        id: 12,
        title: "Activación, compromiso y envío",
        premise: "La intercesión prepara el ambiente espiritual y permite que la alabanza fluya con libertad.",
        objective: "Resaltar la importancia de la oración intercesora para preparar el terreno antes de cada servicio.",
        reflection: "Comprometerse a orar antes y durante el servicio, pidiendo que el Espíritu Santo se mueva y toque los corazones.",
        focus: "Renovar el compromiso, orar unos por otros, establecer metas espirituales y técnicas; cerrar con acto profético.",
        scripture: "Filipenses 1:6; Isaías 6:8",
        tasks: "Formar círculos de intercesión antes de cada servicio; establecer metas espirituales y técnicas; memorizar Filipenses&nbsp;1:6 e Isaías&nbsp;6:8."
      }
    ];

    // Lista de alumnos enumerados.
    const students = Array.from({ length: 12 }, (_, i) => i + 1);

    /*
     * Definición de categorías de evaluación. Cada categoría especifica su clave,
     * nombre visible y un conjunto de opciones. Cada opción tiene el valor
     * numérico (para calcular promedios) y un texto descriptivo que se
     * mostrará en el desplegable. La primera opción vacía permite que se
     * deje la celda sin evaluar.
     */
    const categories = [
      {
        key: 'asistencia',
        label: 'Asistencia',
        options: [
          { value: '', text: 'Seleccionar…' },
          { value: '4', text: '4 – Asistió completo' },
          { value: '3', text: '3 – Ausente una parte' },
          { value: '1', text: '1 – Medio presente' },
          { value: '0', text: '0 – No asistió' }
        ]
      },
      {
        key: 'puntualidad',
        label: 'Puntualidad',
        options: [
          { value: '', text: 'Seleccionar…' },
          { value: '4', text: '4 – Puntual' },
          { value: '2', text: '2 – Un poco tarde' },
          { value: '1', text: '1 – Muy tarde' },
          { value: '0', text: '0 – No llegó' }
        ]
      },
      {
        key: 'participacion',
        label: 'Participación',
        options: [
          { value: '', text: 'Seleccionar…' },
          { value: '4', text: '4 – Participó en toda la sesión' },
          { value: '2', text: '2 – Participó varias veces' },
          { value: '1', text: '1 – Participación mínima' },
          { value: '0', text: '0 – No participó' }
        ]
      },
      {
        key: 'compromiso',
        label: 'Compromiso',
        options: [
          { value: '', text: 'Seleccionar…' },
          { value: '4', text: '4 – Compromiso claro' },
          { value: '2', text: '2 – Compromiso intermedio' },
          { value: '1', text: '1 – Compromiso mínimo' },
          { value: '0', text: '0 – Nulo' }
        ]
      },
      {
        key: 'tarea',
        label: 'Tarea/Responsabilidad',
        options: [
          { value: '', text: 'Seleccionar…' },
          { value: '4', text: '4 – Completa y a tiempo' },
          { value: '2', text: '2 – Incompleta pero en fecha' },
          { value: '1', text: '1 – Tarde' },
          { value: '0', text: '0 – No entregó' }
        ]
      }
    ];

    // Genera la estructura de tarjetas de sesiones con la tabla de evaluación
    function renderSessions() {
      const container = document.getElementById('sessions-container');
      sessions.forEach(session => {
        const card = document.createElement('div');
        card.className = 'session-card';
        // Cabecera
        const header = document.createElement('div');
        header.className = 'session-header';
        header.innerHTML = `Sesión ${session.id}: ${session.title} <span class="toggle-icon">▶</span>`;
        header.addEventListener('click', () => {
          card.classList.toggle('open');
        });
        card.appendChild(header);
        // Cuerpo
        const body = document.createElement('div');
        body.className = 'session-body';
        body.innerHTML += `<p><strong>Premisa:</strong> ${session.premise}</p>`;
        body.innerHTML += `<p><strong>Objetivo:</strong> ${session.objective}</p>`;
        body.innerHTML += `<p><strong>Reflejo:</strong> ${session.reflection}</p>`;
        body.innerHTML += `<p><strong>Enfoque:</strong> ${session.focus}</p>`;
        body.innerHTML += `<p><strong>Base bíblica:</strong> ${session.scripture}</p>`;
        body.innerHTML += `<p><strong>Tareas propuestas:</strong> ${session.tasks}</p>`;
        // Tabla
        const table = document.createElement('table');
        table.className = 'evaluation-table';
        // Encabezado
        const thead = document.createElement('thead');
        let headerRow = '<tr><th>Alumno</th>';
        categories.forEach(cat => {
          headerRow += `<th>${cat.label}</th>`;
        });
        headerRow += '<th>Observaciones</th></tr>';
        thead.innerHTML = headerRow;
        table.appendChild(thead);
        // Cuerpo de la tabla
        const tbody = document.createElement('tbody');
        students.forEach(st => {
          const tr = document.createElement('tr');
          // Columna de alumno
          const nameTd = document.createElement('td');
          nameTd.textContent = `Alumno ${st}`;
          tr.appendChild(nameTd);
          // Para cada categoría añadir un select
          categories.forEach(cat => {
            const td = document.createElement('td');
            const select = document.createElement('select');
            cat.options.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.value;
              option.textContent = opt.text;
              select.appendChild(option);
            });
            select.dataset.sessionId = session.id;
            select.dataset.student = st;
            select.dataset.category = cat.key;
            // recuperar del almacenamiento
            const saved = localStorage.getItem(`s${session.id}_p${st}_${cat.key}`);
            if (saved !== null) {
              select.value = saved;
            }
            select.addEventListener('change', function() {
              localStorage.setItem(`s${this.dataset.sessionId}_p${this.dataset.student}_${this.dataset.category}`, this.value);
              updateStatsSection();
            });
            td.appendChild(select);
            tr.appendChild(td);
          });
          // Observaciones
          const tdObs = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = 'Escribe tus notas aquí…';
          input.dataset.sessionId = session.id;
          input.dataset.student = st;
          input.dataset.category = 'observaciones';
          const savedObs = localStorage.getItem(`s${session.id}_p${st}_observaciones`);
          if (savedObs !== null) {
            input.value = savedObs;
          }
          input.addEventListener('input', function() {
            localStorage.setItem(`s${this.dataset.sessionId}_p${this.dataset.student}_observaciones`, this.value);
          });
          tdObs.appendChild(input);
          tr.appendChild(tdObs);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        body.appendChild(table);
        card.appendChild(body);
        container.appendChild(card);
      });
    }

    // Exporta los datos de localStorage (solo claves que empiezan con 's')
    function exportData() {
      const data = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('s')) {
          data[key] = localStorage.getItem(key);
        }
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'evaluacion_discipulado.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Importa datos desde un archivo JSON y actualiza la interfaz
    function importData(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          Object.keys(data).forEach(key => {
            localStorage.setItem(key, data[key]);
          });
          // Recargar selects con datos importados
          refreshSelects();
          updateStatsSection();
          alert('Datos importados correctamente.');
        } catch (err) {
          alert('Error al importar datos. Asegúrate de que sea un archivo JSON válido.');
        }
      };
      reader.readAsText(file);
    }

    // Recarga todos los selects después de importación
    function refreshSelects() {
      const selects = document.querySelectorAll('table.evaluation-table select');
      selects.forEach(sel => {
        const saved = localStorage.getItem(`s${sel.dataset.sessionId}_p${sel.dataset.student}_${sel.dataset.category}`);
        if (saved !== null) {
          sel.value = saved;
        }
      });
    }

    // Construye la lista de alumnos para las estadísticas
    function populateStudentSelect() {
      const sel = document.getElementById('studentSelect');
      // Agregar opción vacía
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'Seleccionar alumno…';
      sel.appendChild(emptyOption);
      students.forEach(st => {
        const opt = document.createElement('option');
        opt.value = st;
        opt.textContent = `Alumno ${st}`;
        sel.appendChild(opt);
      });
      sel.addEventListener('change', updateStatsSection);
    }

    // Obtiene los datos por alumno y calcula estadísticas
    function calculateStudentStats(studentId) {
      const stats = {
        totals: { asistencia: 0, puntualidad: 0, participacion: 0, compromiso: 0, tarea: 0 },
        counts: { asistencia0: 0, asistencia1: 0, puntualidadLate: 0 },
        sessionsCompleted: 0
      };
      sessions.forEach(sess => {
        let sessionHasData = false;
        categories.forEach(cat => {
          const valueStr = localStorage.getItem(`s${sess.id}_p${studentId}_${cat.key}`);
          const value = valueStr ? parseInt(valueStr) : 0;
          if (valueStr && valueStr !== '') {
            sessionHasData = true;
          }
          stats.totals[cat.key] += value;
          // Conteo de faltas y llegadas tarde
          if (cat.key === 'asistencia') {
            if (value === 0) stats.counts.asistencia0++;
            if (value === 1) stats.counts.asistencia1++;
          }
          if (cat.key === 'puntualidad' && value < 4) {
            // cualquier valor menor a 4 se considera llegada tarde/no llegada
            stats.counts.puntualidadLate++;
          }
        });
        if (sessionHasData) stats.sessionsCompleted++;
      });
      return stats;
    }

    // Actualiza la sección de estadísticas y el gráfico
    function updateStatsSection() {
      const studentId = document.getElementById('studentSelect').value;
      const summaryEl = document.getElementById('stats-summary');
      if (!studentId) {
        summaryEl.textContent = 'Selecciona un alumno para ver sus estadísticas.';
        if (window.studentChartObj) window.studentChartObj.destroy();
        return;
      }
      const stats = calculateStudentStats(studentId);
      // Calcular promedios
      const averages = {};
      const totalPossiblePerSession = 20;
      const totalPossible = sessions.length * totalPossiblePerSession;
      let totalPoints = 0;
      categories.forEach(cat => {
        averages[cat.key] = stats.totals[cat.key] / sessions.length;
        totalPoints += stats.totals[cat.key];
      });
      const percent = ((totalPoints / totalPossible) * 100).toFixed(1);
      // Mostrar resumen textual
      summaryEl.innerHTML =
        `<p><strong>Promedio por indicador (sobre 4):</strong></p>` +
        `<ul>` +
        `<li>Asistencia: ${averages.asistencia.toFixed(2)}</li>` +
        `<li>Puntualidad: ${averages.puntualidad.toFixed(2)}</li>` +
        `<li>Participación: ${averages.participacion.toFixed(2)}</li>` +
        `<li>Compromiso: ${averages.compromiso.toFixed(2)}</li>` +
        `<li>Tarea/Responsabilidad: ${averages.tarea.toFixed(2)}</li>` +
        `</ul>` +
        `<p><strong>Totales:</strong> ${totalPoints} de ${totalPossible} puntos posibles (${percent}%).</p>` +
        `<p><strong>Faltas (no asistió):</strong> ${stats.counts.asistencia0}</p>` +
        `<p><strong>Ausencias parciales (medio presente):</strong> ${stats.counts.asistencia1}</p>` +
        `<p><strong>Llegadas tarde/no llegó:</strong> ${stats.counts.puntualidadLate}</p>`;
      // Preparar datos para Chart.js
      const labels = categories.map(c => c.label);
      const dataValues = categories.map(c => averages[c.key]);
      const ctx = document.getElementById('studentChart').getContext('2d');
      if (window.studentChartObj) window.studentChartObj.destroy();
      // Colores para cada indicador basados en la paleta
      const chartColors = ['#0799b6','#4a6eb0','#114c5f','#9cd2d3','#f2e0cf'];
      window.studentChartObj = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: `Promedio de Alumno ${studentId}`,
            data: dataValues,
            backgroundColor: chartColors,
            borderColor: chartColors,
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 4,
              ticks: { stepSize: 1 },
              title: { display: true, text: 'Promedio (0–4)' }
            },
            x: { title: { display: true, text: 'Indicadores' } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return ` ${context.parsed.y.toFixed(2)}`;
                }
              }
            }
          }
        }
      });

      // Después de actualizar el gráfico individual, actualizar el gráfico global
      updateGlobalChart();
    }

    // Genera el gráfico global con el total de puntos acumulados por alumno
    function updateGlobalChart() {
      const labels = students.map(i => `Alumno ${i}`);
      // Calcular total de puntos por alumno
      const dataValues = students.map(studentId => {
        let total = 0;
        sessions.forEach(sess => {
          categories.forEach(cat => {
            const valueStr = localStorage.getItem(`s${sess.id}_p${studentId}_${cat.key}`);
            const val = valueStr && valueStr !== '' ? parseInt(valueStr) : 0;
            total += val;
          });
        });
        return total;
      });
      const ctxGlobal = document.getElementById('globalChart').getContext('2d');
      // Destruir gráfico previo si existe
      if (window.globalChartObj) window.globalChartObj.destroy();
      // Generar colores para cada barra repitiendo la paleta
      const baseColors = ['#0799b6','#4a6eb0','#114c5f','#9cd2d3','#f2e0cf'];
      const barColors = dataValues.map((_, idx) => baseColors[idx % baseColors.length]);
      window.globalChartObj = new Chart(ctxGlobal, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total de puntos',
            data: dataValues,
            backgroundColor: barColors,
            borderColor: barColors,
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              // El máximo dependerá de 240 puntos posibles
              max: sessions.length * 20,
              title: { display: true, text: 'Puntos acumulados' }
            },
            x: {
              title: { display: true, text: 'Alumnos' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const val = context.parsed.y;
                  return ` ${val} pts`;
                }
              }
            }
          }
        }
      });
    }

    // Inicializar la página: generar sesiones, poblar select y enlazar botones
    function init() {
      renderSessions();
      populateStudentSelect();
      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('importFile').addEventListener('change', importData);
      updateStatsSection();
      // Cargar gráfico global inicialmente
      updateGlobalChart();
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>